<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Family Tree â€“ linkType dinamico</title>
  <style>
    body { margin: 0; }
    canvas {
      background-color: #f0f0f0;
      display: block;
      margin: 0 auto;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 400px;
    }
    .modal-close {
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: #aaa;
    }
    .modal-close:hover, .modal-close:focus {
      color: black; text-decoration: none;
    }
    .form-group {
      margin-bottom: 10px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 4px;
    }
    input, select {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
      margin-bottom: 4px;
    }
    .btn {
      padding: 8px 16px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-save {
      background-color: #28a745;
      color: #fff;
      margin-right: 10px;
    }
    .btn-cancel {
      background-color: #dc3545;
      color: #fff;
    }
  </style>
</head>
<body>
  <canvas id="meuCanvas" width="1200" height="800"></canvas>

  <!-- modal: adicionar novo membro -->
  <div id="modal-adicionar" class="modal">
    <div class="modal-content">
      <span id="modal-adicionar-fechar" class="modal-close">&times;</span>
      <h2>Adicionar Novo Membro</h2>
      <div class="form-group">
        <label for="entradaNome">Nome Completo</label>
        <input type="text" id="entradaNome" placeholder="Nome e sobrenome" />
      </div>
      <div class="form-group">
        <label for="entradaNascimento">Nascimento</label>
        <input type="text" id="entradaNascimento" placeholder="dd/mm/aaaa" />
      </div>
      <div class="form-group">
        <label for="entradaGenero">Genero</label>
        <select id="entradaGenero">
          <option value="Masculino">Masculino</option>
          <option value="Feminino">Feminino</option>
          <option value="Outro">Outro</option>
        </select>
      </div>
      <div class="form-group">
        <label for="entradaPais">Pais</label>
        <input type="text" id="entradaPais" placeholder="Brasil" />
      </div>
      <div class="form-group">
        <label for="entradaParentesco">Parentesco</label>
        <select id="entradaParentesco" disabled></select>
      </div>
      <button class="btn btn-save" id="botaoAdicionarSalvar">Salvar alteracoes</button>
      <button class="btn btn-cancel" id="botaoAdicionarCancelar">Cancelar</button>
    </div>
  </div>

  <script>
    // variaveis globais
    let visao = { deslocamentoX: 0, deslocamentoY: 0, escala: 1 };
    let membros = [];
    let contadorMembros = 1;

    function gerarUUID() {
      return ([1e7]+-1e3+-4e3+-8e3+-1e11)
        .replace(/[018]/g, c =>
          (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
        );
    }

    function criarMembro(x, y, tamanho) {
      return {
        id: gerarUUID(),
        nome: "Novo Membro " + contadorMembros++,
        dataNascimento: null,
        genero: null,
        pais: null,
        grauParentesco: null,
        posicaoTela: { x: x, y: y, tamanho: tamanho },
        somenteLink: false,
        conexoes: [],
        criadoEm: new Date().toISOString(),
        atualizadoEm: new Date().toISOString()
      };
    }

    function salvarEstado() {
      const estado = { visao: visao, membros: membros, contadorMembros: contadorMembros };
      localStorage.setItem("estadoArvoreFamiliar", JSON.stringify(estado));
    }
    function carregarEstado() {
      const salvo = localStorage.getItem("estadoArvoreFamiliar");
      if (salvo) {
        const est = JSON.parse(salvo);
        visao = est.visao;
        membros = est.membros;
        contadorMembros = est.contadorMembros;
      } else {
        // primeiro membro: "eu"
        const inicial = criarMembro(350, 250, 100);
        inicial.id = "00000000-0000-0000-0000-000000000000";
        inicial.nome = "Eu";
        inicial.grauParentesco = "Eu";
        membros.push(inicial);
      }
    }

    // regras: definindo os tipos de ancestrais e descendentes.
    const linhaPai = ["pai", "vo", "bisavo", "tataravo"];
    const linhaFilho  = ["filho", "neto", "bisneto", "tataraneto"];

    function obterParentescoAutomatico(membroOrigem, direcao) {
      const pk = membroOrigem.grauParentesco || "Eu";
      if (direcao === "topo") {
        if (["primo", "irmao", "tio"].includes(pk.toLowerCase())) return "tio";
        let idx = linhaPai.indexOf(pk.toLowerCase());
        if (pk === "Eu" || idx === -1) return linhaPai[0];
        if (idx < linhaPai.length - 1) return linhaPai[idx + 1];
        return linhaPai[linhaPai.length - 1];
      } else if (direcao === "baixo") {
        let idx = linhaFilho.indexOf(pk.toLowerCase());
        if (pk === "Eu" || idx === -1) return linhaFilho[0];
        if (idx < linhaFilho.length - 1) return linhaFilho[idx + 1];
        return linhaFilho[linhaFilho.length - 1];
      } else if (direcao === "esquerda") {
        if (pk === "Eu" || pk.toLowerCase() === "irmao") return "irmao";
        return "tio";
      } else if (direcao === "direita") {
        if (pk === "Eu" || pk.toLowerCase() === "primo") return "primo";
        return "tio";
      }
      return "outro";
    }

    function temPaiOuMae(membro) {
      return membro.conexoes.some(con => con.tipoLink.toLowerCase() === "pai" || con.tipoLink.toLowerCase() === "mae");
    }

    // compartilha parentes com outro(m)
    // se o membro m (exceto "eu") aponta para algum ancestral (com tipolink em linhapai)
    // e existe outro membro que tambem aponta para esse mesmo ancestral, retorna true.
    function compartilhaParentesComOutro(membro) {
      if (membro.grauParentesco === "Eu") return false; // "eu" sempre exibe o +
      // pega as conexoes de membro que sao ancestrais
      const conexoesAncestrais = membro.conexoes.filter(con => linhaPai.includes(con.tipoLink.toLowerCase()));
      if (conexoesAncestrais.length === 0) return false;
      // para cada conexao ancestral de membro, veja se ha outro membro apontando para o mesmo ancestral.
      for (let conAnc of conexoesAncestrais) {
        const idAnc = conAnc.idDestino;
        let cont = 0;
        for (let outro of membros) {
          if (outro.somenteLink) continue;
          const c2 = outro.conexoes.filter(con => linhaPai.includes(con.tipoLink.toLowerCase()) && con.idDestino === idAnc);
          if (c2.length > 0) {
            cont++;
          }
        }
        if (cont >= 2) return true;
      }
      return false;
    }

    // captura elementos
    const modalAdicionar = document.getElementById("modal-adicionar");
    const modalAdicionarFechar = document.getElementById("modal-adicionar-fechar");
    const entradaNome = document.getElementById("entradaNome");
    const entradaNascimento = document.getElementById("entradaNascimento");
    const entradaGenero = document.getElementById("entradaGenero");
    const entradaPais = document.getElementById("entradaPais");
    const entradaParentesco = document.getElementById("entradaParentesco");
    const botaoAdicionarSalvar = document.getElementById("botaoAdicionarSalvar");
    const botaoAdicionarCancelar = document.getElementById("botaoAdicionarCancelar");

    modalAdicionarFechar.onclick = fecharModalAdicionar;
    botaoAdicionarSalvar.onclick = confirmarAdicionarMembro;
    botaoAdicionarCancelar.onclick = fecharModalAdicionar;

    let membroPendente = null;
    let direcaoPendente = null;

    // mostrar modal adicionar
    function mostrarModalAdicionar(membroOrigem, direcao) {
      membroPendente = membroOrigem;
      direcaoPendente = direcao;
      entradaNome.value = "";
      entradaNascimento.value = "";
      entradaGenero.value = "Masculino";
      entradaPais.value = "Brasil";
      entradaParentesco.innerHTML = "";

      // ----- caso "tio" + topo -----
      if (membroOrigem.grauParentesco.toLowerCase() === "tio" && direcao === "topo") {
        let ops = [];
        const vosExistentes = membros.filter(m => m.grauParentesco.toLowerCase() === "vo" && !m.somenteLink);
        vosExistentes.forEach(vo => {
          const jaConectado = membroOrigem.conexoes.some(c => c.idDestino === vo.id);
          if (!jaConectado) {
            ops.push({
              value: "conectar-vo-" + vo.id,
              label: `Conectar com vo - ${vo.nome}`
            });
          }
        });
        const tiosAvoExistentes = membros.filter(m => m.grauParentesco.toLowerCase() === "tio-avo" && !m.somenteLink);
        tiosAvoExistentes.forEach(ta => {
          const jaConectado = membroOrigem.conexoes.some(c => c.idDestino === ta.id);
          if (!jaConectado) {
            ops.push({
              value: "conectar-tioavo-" + ta.id,
              label: `Conectar com tio-avo - ${ta.nome}`
            });
          }
        });
        ops.push({
          value: "criar-tioavo",
          label: "Criar novo tio-avo"
        });
        ops.forEach(({ value, label }) => {
          const opt = document.createElement("option");
          opt.value = value;
          opt.textContent = label;
          entradaParentesco.appendChild(opt);
        });
        entradaParentesco.disabled = false;
        modalAdicionar.style.display = "block";
        return;
      }

      // ----- caso "tio-avo" + topo -----
      if (membroOrigem.grauParentesco.toLowerCase() === "tio-avo" && direcao === "topo") {
        let ops = [];
        const bisavosExistentes = membros.filter(m => m.grauParentesco.toLowerCase() === "bisavo" && !m.somenteLink);
        bisavosExistentes.forEach(bv => {
          const jaConectado = membroOrigem.conexoes.some(c => c.idDestino === bv.id);
          if (!jaConectado) {
            ops.push({
              value: "conectar-bisavo-" + bv.id,
              label: `Conectar com bisavo - ${bv.nome}`
            });
          }
        });
        ops.forEach(({ value, label }) => {
          const opt = document.createElement("option");
          opt.value = value;
          opt.textContent = label;
          entradaParentesco.appendChild(opt);
        });
        entradaParentesco.disabled = false;
        modalAdicionar.style.display = "block";
        return;
      }

      // ----- caso "primo" + topo -----
      if (membroOrigem.grauParentesco.toLowerCase() === "primo" && direcao === "topo") {
        let ops = [];
        // buscamos todos os membros com grau de parentesco "tio"
        const tiosExistentes = membros.filter(m => m.grauParentesco.toLowerCase() === "tio" && !m.somenteLink);
        tiosExistentes.forEach(tio => {
          // verifica se o primo ja esta conectado a esse tio
          const jaConectado = membroOrigem.conexoes.some(c => c.idDestino === tio.id);
          if (!jaConectado) {
            ops.push({
              value: "conectar-tio-" + tio.id,
              label: `Conectar com tio - ${tio.nome}`
            });
          }
        });
        // opcao de criar um novo tio
        ops.push({
          value: "criar-tio",
          label: "Criar novo tio"
        });
        ops.forEach(({ value, label }) => {
          const opt = document.createElement("option");
          opt.value = value;
          opt.textContent = label;
          entradaParentesco.appendChild(opt);
        });
        entradaParentesco.disabled = false;
        modalAdicionar.style.display = "block";
        return;
      }

      // ----- caso normal (ex. eu, irmao, filho, etc.) -----
      const parentescoAuto = obterParentescoAutomatico(membroOrigem, direcao);
      const opt = document.createElement("option");
      opt.value = parentescoAuto;
      opt.textContent = parentescoAuto;
      entradaParentesco.appendChild(opt);
      entradaParentesco.disabled = true;
      modalAdicionar.style.display = "block";
    }

    function fecharModalAdicionar() {
      modalAdicionar.style.display = "none";
      membroPendente = null;
      direcaoPendente = null;
    }

    function confirmarAdicionarMembro() {
      if (!membroPendente || !direcaoPendente) {
        fecharModalAdicionar();
        return;
      }
      const valorSelecionado = entradaParentesco.value;

      // conexoes especiais
      // (tio + topo) -> conectar a vo existente
      if (valorSelecionado.startsWith("conectar-vo-")) {
        const idVo = valorSelecionado.replace("conectar-vo-", "");
        const voExistente = membros.find(m => m.id === idVo);
        if (voExistente) {
          membroPendente.conexoes.push({
            idDestino: voExistente.id,
            direcao: direcaoPendente,
            tipoLink: "vo",
            somenteLink: false
          });
        }
        fecharModalAdicionar();
        desenharTudo();
        salvarEstado();
        return;
      }

      // (tio + topo) -> conectar a tio-avo existente
      if (valorSelecionado.startsWith("conectar-tioavo-")) {
        const idTioAvo = valorSelecionado.replace("conectar-tioavo-", "");
        const tioAvoExistente = membros.find(m => m.id === idTioAvo);
        if (tioAvoExistente) {
          membroPendente.conexoes.push({
            idDestino: tioAvoExistente.id,
            direcao: direcaoPendente,
            tipoLink: "tio-avo",
            somenteLink: false
          });
        }
        fecharModalAdicionar();
        desenharTudo();
        salvarEstado();
        return;
      }

      // (tio + topo) -> criar novo tio-avo
      if (valorSelecionado === "criar-tioavo") {
        criarEConectar("tio-avo");
        return;
      }

      // (tio-avo + topo) -> conectar a bisavo existente
      if (valorSelecionado.startsWith("conectar-bisavo-")) {
        const idBisavo = valorSelecionado.replace("conectar-bisavo-", "");
        const bisavoExistente = membros.find(m => m.id === idBisavo);
        if (bisavoExistente) {
          membroPendente.conexoes.push({
            idDestino: bisavoExistente.id,
            direcao: direcaoPendente,
            tipoLink: "bisavo",
            somenteLink: false
          });
        }
        fecharModalAdicionar();
        desenharTudo();
        salvarEstado();
        return;
      }

      // (primo + baixo) -> conectar a tio existente
      if (valorSelecionado.startsWith("conectar-tio-")) {
        const idTio = valorSelecionado.replace("conectar-tio-", "");
        const tioExistente = membros.find(m => m.id === idTio);
        if (tioExistente) {
          membroPendente.conexoes.push({
            idDestino: tioExistente.id,
            direcao: direcaoPendente,
            tipoLink: "tio",
            somenteLink: false
          });
        }
        fecharModalAdicionar();
        desenharTudo();
        salvarEstado();
        return;
      }

      // (primo + baixo) -> criar novo tio
      if (valorSelecionado === "criar-tio") {
        criarEConectar("tio");
        return;
      }

      // caso normal (ex: filho, irmao, etc.)
      criarEConectar(valorSelecionado);

      function criarEConectar(tipo) {
        const posOrigem = membroPendente.posicaoTela;
        let x = posOrigem.x, y = posOrigem.y, t = posOrigem.tamanho;
        if (direcaoPendente === "topo")    y = posOrigem.y - t;
        if (direcaoPendente === "baixo")   y = posOrigem.y + t;
        if (direcaoPendente === "esquerda") x = posOrigem.x - t;
        if (direcaoPendente === "direita")  x = posOrigem.x + t;

        const novoMembro = criarMembro(x, y, t);
        novoMembro.nome = entradaNome.value || ("Membro " + contadorMembros);
        novoMembro.grauParentesco = tipo;
        novoMembro.dataNascimento = entradaNascimento.value;
        novoMembro.genero = entradaGenero.value;
        novoMembro.pais = entradaPais.value;
        membros.push(novoMembro);

        membroPendente.conexoes.push({
          idDestino: novoMembro.id,
          direcao: direcaoPendente,
          tipoLink: tipo,
          somenteLink: false
        });

        fecharModalAdicionar();
        desenharTudo();
        salvarEstado();
      }
    }

    // desenho
    const elementoCanvas = document.getElementById("meuCanvas");
    const contexto = elementoCanvas.getContext("2d");

    function desenharTudo() {
      contexto.clearRect(0, 0, elementoCanvas.width, elementoCanvas.height);
      contexto.save();
      contexto.translate(visao.deslocamentoX, visao.deslocamentoY);
      contexto.scale(visao.escala, visao.escala);
      desenharGrade();
      desenharConexoes();
      desenharMembros();
      contexto.restore();
    }

    function desenharGrade() {
      const tamanhoGrade = 20;
      contexto.strokeStyle = "#ccc";
      contexto.lineWidth = 0.5 / visao.escala;
      let esquerda = -visao.deslocamentoX / visao.escala;
      let topo = -visao.deslocamentoY / visao.escala;
      let direita = esquerda + elementoCanvas.width / visao.escala;
      let base = topo + elementoCanvas.height / visao.escala;
      let inicioX = Math.floor(esquerda / tamanhoGrade) * tamanhoGrade;
      let inicioY = Math.floor(topo / tamanhoGrade) * tamanhoGrade;

      for (let x = inicioX; x <= direita; x += tamanhoGrade) {
        contexto.beginPath();
        contexto.moveTo(x, topo);
        contexto.lineTo(x, base);
        contexto.stroke();
      }
      for (let y = inicioY; y <= base; y += tamanhoGrade) {
        contexto.beginPath();
        contexto.moveTo(esquerda, y);
        contexto.lineTo(direita, y);
        contexto.stroke();
      }
    }

    function desenharConexoes() {
      contexto.strokeStyle = "blue";
      contexto.lineWidth = 2 / visao.escala;
      membros.forEach(membro => {
        if (membro.somenteLink) return;
        const posM = membro.posicaoTela;
        membro.conexoes.forEach(con => {
          const destino = membros.find(x => x.id === con.idDestino);
          if (!destino) return;
          const posD = destino.posicaoTela;
          let inicioX, inicioY, fimX, fimY;
          if (con.direcao === "topo") {
            inicioX = posM.x + posM.tamanho / 2;
            inicioY = posM.y;
            fimX = posD.x + posD.tamanho / 2;
            fimY = posD.y + posD.tamanho;
          } else if (con.direcao === "baixo") {
            inicioX = posM.x + posM.tamanho / 2;
            inicioY = posM.y + posM.tamanho;
            fimX = posD.x + posD.tamanho / 2;
            fimY = posD.y;
          } else if (con.direcao === "esquerda") {
            inicioX = posM.x;
            inicioY = posM.y + posM.tamanho / 2;
            fimX = posD.x + posD.tamanho;
            fimY = posD.y + posD.tamanho / 2;
          } else if (con.direcao === "direita") {
            inicioX = posM.x + posM.tamanho;
            inicioY = posM.y + posM.tamanho / 2;
            fimX = posD.x;
            fimY = posD.y + posD.tamanho / 2;
          } else {
            // fallback
            inicioX = posM.x + posM.tamanho / 2;
            inicioY = posM.y + posM.tamanho / 2;
            fimX = posD.x + posD.tamanho / 2;
            fimY = posD.y + posD.tamanho / 2;
          }
          contexto.beginPath();
          contexto.moveTo(inicioX, inicioY);
          contexto.lineTo(fimX, fimY);
          contexto.stroke();
        });
      });
    }

    // offset para posicionar o "+" mais afastado do quadrado
    const distanciaDeslocamento = 20;

    function desenharMais(cx, cy) {
      contexto.save();
      contexto.strokeStyle = "black";
      contexto.lineWidth = 3;
      const r = 10;
      contexto.beginPath();
      contexto.moveTo(cx, cy - r);
      contexto.lineTo(cx, cy + r);
      contexto.stroke();
      contexto.beginPath();
      contexto.moveTo(cx - r, cy);
      contexto.lineTo(cx + r, cy);
      contexto.stroke();
      contexto.restore();
    }

    function desenharMembros() {
      membros.forEach(membro => {
        if (membro.somenteLink) return;
        const pos = membro.posicaoTela;
        contexto.fillStyle = "#4CAF50";
        contexto.fillRect(pos.x, pos.y, pos.tamanho, pos.tamanho);
        const metade = pos.tamanho / 2;
        
        // se membro nao for "eu" e compartilhar um ancestral com outro, nao desenha "+"
        if (membro.grauParentesco !== "Eu" && compartilhaParentesComOutro(membro)) {
          desenharTextoMembro(membro);
          return;
        }
        
        // desenha "+" no topo se nao tiver pai/mae e nao for "irmao"
        if (!temPaiOuMae(membro) && membro.grauParentesco.toLowerCase() !== "irmao") {
          desenharMais(pos.x + metade, pos.y - distanciaDeslocamento);
        }

        // desenha "+" embaixo e laterais para "eu", "irmao" e "primo"
        if (["Eu", "irmao", "primo"].includes(membro.grauParentesco)) {
          // embaixo
          desenharMais(pos.x + metade, pos.y + pos.tamanho + distanciaDeslocamento);

          // para "eu" e "irmao", desenha "+" a esquerda
          if (membro.grauParentesco.toLowerCase() !== "primo") {
            desenharMais(pos.x - distanciaDeslocamento, pos.y + metade);
          }
          // para "eu", desenha "+" a direita
          if (membro.grauParentesco.toLowerCase() !== "irmao" && membro.grauParentesco.toLowerCase() !== "primo") {
            desenharMais(pos.x + pos.tamanho + distanciaDeslocamento, pos.y + metade);
          }
        }

        desenharTextoMembro(membro);
      });
    }

    function desenharTextoMembro(membro) {
      const pos = membro.posicaoTela;
      contexto.fillStyle = "white";
      contexto.font = `bold ${12 / visao.escala}px Arial`;
      contexto.fillText("editar", pos.x + pos.tamanho - 50, pos.y + pos.tamanho - 5);
      contexto.fillStyle = "black";
      contexto.font = `${12 / visao.escala}px Arial`;
      contexto.textAlign = "center";
      contexto.textBaseline = "top";
      contexto.fillText(membro.grauParentesco || "", pos.x + pos.tamanho / 2, pos.y + 2);
      contexto.font = `${14 / visao.escala}px Arial`;
      contexto.textBaseline = "middle";
      contexto.fillText(membro.nome, pos.x + pos.tamanho / 2, pos.y + pos.tamanho / 2);
    }

    // arraste e zoom
    let membroArrastando = null;
    let deslocamentoArraste = { x: 0, y: 0 };
    let arrastandoGrade = false;
    let inicioArrasteGrade = { x: 0, y: 0 };
    let deslocamentoInicialVisao = { deslocamentoX: 0, deslocamentoY: 0 };

    elementoCanvas.addEventListener("wheel", (e) => {
      e.preventDefault();
      const mx = e.offsetX, my = e.offsetY;
      const antes = obterCoordenadasMundo(mx, my);
      // zoom in/out
      if (e.deltaY < 0) visao.escala *= 1.1;
      else visao.escala /= 1.1;
      visao.deslocamentoX = mx - antes.x * visao.escala;
      visao.deslocamentoY = my - antes.y * visao.escala;
      desenharTudo();
      salvarEstado();
    });

    elementoCanvas.addEventListener("mousedown", tratarInicio);
    elementoCanvas.addEventListener("touchstart", tratarInicio);
    elementoCanvas.addEventListener("mousemove", tratarMovimento);
    elementoCanvas.addEventListener("touchmove", tratarMovimento);
    elementoCanvas.addEventListener("mouseup", tratarFim);
    elementoCanvas.addEventListener("touchend", tratarFim);
    elementoCanvas.addEventListener("touchcancel", tratarFim);

    function obterCoordenadasPonteiro(e) {
      const retangulo = elementoCanvas.getBoundingClientRect();
      if (e.touches && e.touches.length > 0) {
        return { x: e.touches[0].clientX - retangulo.left, y: e.touches[0].clientY - retangulo.top };
      }
      return { x: e.offsetX, y: e.offsetY };
    }
    function obterCoordenadasMundo(mx, my) {
      return {
        x: (mx - visao.deslocamentoX) / visao.escala,
        y: (my - visao.deslocamentoY) / visao.escala
      };
    }

    function tratarInicio(e) {
      e.preventDefault();
      const ponteiro = obterCoordenadasPonteiro(e);
      const posMundo = obterCoordenadasMundo(ponteiro.x, ponteiro.y);
      const mx = posMundo.x, my = posMundo.y;

      // 1) verifica clique no "+"
      for (let membro of membros) {
        if (membro.somenteLink) continue;
        const pos = membro.posicaoTela;
        const metade = pos.tamanho / 2;

        // "+" no topo
        if (!temPaiOuMae(membro) && membro.grauParentesco.toLowerCase() !== "irmao") {
          if (clicouNoMais(mx, my, pos.x + metade, pos.y - distanciaDeslocamento)) {
            mostrarModalAdicionar(membro, "topo");
            return;
          }
        }

        // "+" embaixo e laterais para eu, irmao, primo
        if (["Eu", "irmao", "primo"].includes(membro.grauParentesco)) {
          // embaixo
          if (clicouNoMais(mx, my, pos.x + metade, pos.y + pos.tamanho + distanciaDeslocamento)) {
            mostrarModalAdicionar(membro, "baixo");
            return;
          }
          // esquerda
          if (membro.grauParentesco.toLowerCase() !== "primo") {
            if (clicouNoMais(mx, my, pos.x - distanciaDeslocamento, pos.y + metade)) {
              mostrarModalAdicionar(membro, "esquerda");
              return;
            }
          }
          // direita
          if (membro.grauParentesco.toLowerCase() !== "irmao" && membro.grauParentesco.toLowerCase() !== "primo") {
            if (clicouNoMais(mx, my, pos.x + pos.tamanho + distanciaDeslocamento, pos.y + metade)) {
              mostrarModalAdicionar(membro, "direita");
              return;
            }
          }
        }
      }

      // 2) verifica se clicou no quadrado para arrastar
      for (let i = membros.length - 1; i >= 0; i--) {
        const membro = membros[i];
        if (membro.somenteLink) continue;
        const pos = membro.posicaoTela;
        if (pontoDentroRetangulo(mx, my, pos.x, pos.y, pos.tamanho, pos.tamanho)) {
          membroArrastando = membro;
          deslocamentoArraste.x = mx - pos.x;
          deslocamentoArraste.y = my - pos.y;
          return;
        }
      }
      
      // 3) arrasta grade
      arrastandoGrade = true;
      inicioArrasteGrade = { x: ponteiro.x, y: ponteiro.y };
      deslocamentoInicialVisao = { deslocamentoX: visao.deslocamentoX, deslocamentoY: visao.deslocamentoY };
    }

    function tratarMovimento(e) {
      e.preventDefault();
      const ponteiro = obterCoordenadasPonteiro(e);

      if (membroArrastando) {
        const posMundo = obterCoordenadasMundo(ponteiro.x, ponteiro.y);
        membroArrastando.posicaoTela.x = posMundo.x - deslocamentoArraste.x;
        membroArrastando.posicaoTela.y = posMundo.y - deslocamentoArraste.y;
        desenharTudo();
      } else if (arrastandoGrade) {
        const dx = ponteiro.x - inicioArrasteGrade.x;
        const dy = ponteiro.y - inicioArrasteGrade.y;
        visao.deslocamentoX = deslocamentoInicialVisao.deslocamentoX + dx;
        visao.deslocamentoY = deslocamentoInicialVisao.deslocamentoY + dy;
        desenharTudo();
      }
    }

    function tratarFim(e) {
      e.preventDefault();
      if (membroArrastando || arrastandoGrade) {
        salvarEstado();
      }
      membroArrastando = null;
      arrastandoGrade = false;
    }

    function pontoDentroRetangulo(px, py, cx, cy, largura, altura) {
      return px >= cx && px <= cx + largura && py >= cy && py <= cy + altura;
    }
    function clicouNoMais(mx, my, cx, cy) {
      const dx = mx - cx;
      const dy = my - cy;
      const distancia = Math.sqrt(dx * dx + dy * dy);
      return distancia <= 10; 
    }

    // inicializa
    carregarEstado();
    desenharTudo();
  </script>
</body>
</html>
